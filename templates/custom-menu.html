{% extends "admin/common/base.html" %}
{% block styles %}
<!-- DataTables -->
<link rel="stylesheet" href="/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="/plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
{% endblock %}
{% block container %}
<div class="row">
  <div class="col-md-4">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">粉丝标签为“{{tagTitle}}”的菜单</h3>
      </div>
      <div id="tags" class="card-body">
        <button class="btn btn-outline-info mr-2" data-id="">默认</button>
        {% for tag in tags %}
        <button class="btn btn-outline-info mr-2" data-id="{{tag.id}}">{{tag.name}}</button>
        {% endfor %}
      </div>
      <!-- /.card-body -->
    </div>

    <div class="card">
      <div class="card-body mb-5 mt-5 pt-5 pb-5">

      </div>
      <!-- /.card-body -->
      <div class="card-footer">
        <div class="row">
          {% for menu in menus %}
          <div class="w-25 btn-group">
            <div class="btn-group dropup">
              <button class="btn btn-sm editMenu" data-menu="{{ menu|json_encode }}" data-toggle="tooltip" title="点击修改">
                {{menu.name}}
              </button>
              <button type="button" class="btn btn-sm dropdown-toggle dropdown-toggle-split" data-toggle="dropdown" aria-haspopup="true"
                      aria-expanded="false">
              </button>
              <div class="dropdown-menu">
                {% for btn in menu.subBtn %}
                <button class="dropdown-item editMenu" data-menu="{{ btn|json_encode }}">{{btn.name}}</button>
                <div class="dropdown-divider"></div>
                {% endfor %}
                {% if menu.subBtn|length < 7 %}
                <button class="dropdown-item text-center addMenu" data-menu="{{ menu|json_encode }}"><i class="fa fa-plus"></i></button>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
          <div class="w-25 btn-group">
            {% if menus|length < 3 %}
            <button class="btn btn-link mr-2 addMenu" data-toggle="tooltip" title="添加一级菜单"><i class="fa fa-plus"></i></button>
            {% endif %}
            <button id="createMenu" class="btn btn-link" data-toggle="tooltip" title="生成菜单"><i class="fas fa-cloud-upload-alt"></i></button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-8">
    <div class="card">
      <div class="card-header">
        <h3 id="menuTitle" class="card-title">{{menuTitle}}</h3>
      </div>
      <div class="card-body">
        <form id="menuForm" action="/admin/weixin/menu" method="POST"
              novalidate="novalidate">
          <div class="form-group">
            <input name="parent_id" type="hidden">
            <input name="tag_id" type="hidden" value="{{tag_id}}">
            <label for="name">菜单名称</label>
            <input name="name" type="text" class="form-control required" placeholder="菜单名称" id="name" autocomplete="off">
          </div>
          <div class="form-group">
            <label>类型</label>
            <select name="type" class="form-control required">
              <option value="click">点击推事件</option>
              <option value="view">跳转URL</option>
              <option value="miniprogram">小程序</option>
              <option value="scancode_push">扫码推事件</option>
              <option value="scancode_waitmsg">扫码推事件且弹出“消息接收中”提示框</option>
              <option value="pic_sysphoto">弹出系统拍照发图</option>
              <option value="pic_photo_or_album">弹出拍照或者相册发图</option>
              <option value="pic_weixin">弹出微信相册发图器</option>
              <option value="location_select">弹出地理位置选择器</option>
            </select>
          </div>
          <div class="form-group key">
            <label>菜单KEY值</label>
            <input name="key" type="text" class="form-control" placeholder="菜单KEY值">
          </div>
          <div class="form-group url" style="display: none">
            <label>菜单链接</label>
            <input name="url" type="text" class="form-control" placeholder="菜单链接">
          </div>
          <div class="form-group miniprogram" style="display: none">
            <label>小程序的appid</label>
            <input name="appid" type="text" class="form-control" placeholder="小程序的appid">
          </div>
          <div class="form-group miniprogram" style="display: none">
            <label>小程序的页面路径</label>
            <input name="pagepath" type="text" class="form-control" placeholder="小程序的页面路径">
          </div>
          <div class="form-group">
            <label>显示排序</label>
            <input name="sortOrder" type="text" class="form-control" placeholder="显示排序">
          </div>
        </form>
      </div>
      <!-- /.card-body -->
      <div class="card-footer">
        {% if menus|length < 3 %}
        <button type="submit" class="btn btn-outline-primary mr-2" form="menuForm">提交</button>
        {% else %}
        <button type="submit" class="btn btn-outline-primary mr-2 disabled" disabled form="menuForm">提交</button>
        {% endif %}
        <button type="button" class="btn btn-outline-danger" style="display: none">删除</button>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/adminlte/plugins/jquery-validation/jquery.validate.min.js"></script>
<script src="/adminlte/plugins/jquery-validation/additional-methods.min.js"></script>
<script src="/adminlte/plugins/jquery-validation/localization/messages_zh.min.js"></script>
<script type="text/javascript">
  $(document).ready(function () {
    $("#menuForm select[name='type']").on('change', function () {
      if ($(this).val() == 'miniprogram') $("#menuForm .miniprogram").show();
      else $("#menuForm .miniprogram").hide();
      if ($(this).val() == 'view' || $(this).val() == 'miniprogram') {
        $("#menuForm .url").show();
        $("#menuForm .key").hide();
      } else {
        $("#menuForm .url").hide();
        $("#menuForm .key").show();
      }
    });

    $('#tags button[data-id]').on('click', function () {
      if ($(this).attr('data-id')) location.href = '/admin/weixin/menu/' + $(this).attr('data-id');
      else location.href = '/admin/weixin/menu';
    });

    $('.addMenu').click(function () {
      if (!$(this).attr('data-menu')) {
        $('#menuTitle').text('添加{{tagTitle}}一级菜单');
      } else {
        var menu = JSON.parse($(this).attr('data-menu'));
        $("#menuForm input[name='parent_id']").val(menu.id);
        $('#menuTitle').text('添加{{tagTitle}}“' + menu.name + '”的二级菜单');
      }
      $('#menuForm').attr('action', '/admin/weixin/menu');
      $('#menuForm').attr('method', 'POST');
      $('#menuForm')[0].reset();
      $(".btn-outline-danger").hide();
      $(".btn-outline-primary").removeClass('disabled').attr('disabled', false);
    });

    $(".btn-outline-danger").click(function () {
      var id = $(this).parents('tr').attr('data-id');
      dialog('是否确认删除此菜单', '删除后不可以恢复。', function () {
        $.ajax({
          url: $('#menuForm').attr('action'),
          type: 'POST',
          headers: {"X-HTTP-Method-Override": "DELETE"},
          dataType: 'json',
          success: function (json) {
            setTimeout(() => {
              location.reload();
            }, 1500);
            Swal.fire({icon: 'success', title: '删除成功！', showConfirmButton: false, timer: 1500});
          },
          error: errorDialog
        });
      });
    });
    $("#createMenu").click(function () {
      $.ajax({
        url: '/admin/weixin/createMenu',
        type: 'POST',
        data: {tag_id: $("#menuForm input[name='tag_id']").val()},
        dataType: 'json',
        success: function (json) {
          Swal.fire({icon: 'success', title: '生成成功！', showConfirmButton: false, timer: 1500});
        },
        error: errorDialog
      });
    });

    $('.editMenu').click(function () {
      if (!$(this).attr('data-menu')) {
        $('#menuTitle').text('修改{{tagTitle}}一级菜单');
      } else {
        var menu = JSON.parse($(this).attr('data-menu'));
        $('#menuTitle').text('修改{{tagTitle}}二级菜单');
      }
      $('#menuForm').attr('action', '/admin/weixin/menu/' + menu.id);
      $('#menuForm').attr('method', 'PUT');
      $("#menuForm input[name='tag_id']").val(menu.tag_id);
      $("#menuForm input[name='name']").val(menu.name);
      $("#menuForm select[name='type']").val(menu.type).change();
      $("#menuForm input[name='parent_id']").val(menu.parent_id);
      $("#menuForm input[name='key']").val(menu.key);
      $("#menuForm input[name='url']").val(menu.url);
      $("#menuForm input[name='appid']").val(menu.appid);
      $("#menuForm input[name='pagepath']").val(menu.pagepath);
      $("#menuForm input[name='sortOrder']").val(menu.sortOrder);
      $(".btn-outline-danger").show();
      $(".btn-outline-primary").removeClass('disabled').attr('disabled', false);
    });

    $('#menuForm').validate({
      submitHandler: function (e) {
        var fromdata = new FormData(e);
        $.ajax({
          url: $(e).attr('action'),
          data: fromdata,
          type: 'POST',
          cache: false,
          contentType: false,
          processData: false,
          dataType: 'json',
          beforeSend: function (xhr) {
            xhr.setRequestHeader("X-HTTP-Method-Override", $(e).attr('method'));
          },
          success: function (json) {
            location.reload();
          },
          error: errorDialog
        });
        return false;
      },
      errorElement: 'span',
      errorPlacement: function (error, element) {
        error.addClass('invalid-feedback');
        element.closest('.form-group').append(error);
      },
      highlight: function (element, errorClass, validClass) {
        $(element).addClass('is-invalid');
      },
      unhighlight: function (element, errorClass, validClass) {
        $(element).removeClass('is-invalid');
      }
    });

  });
</script>
{% endblock %}
